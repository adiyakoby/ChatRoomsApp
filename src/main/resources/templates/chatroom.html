<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <link rel="stylesheet" th:href="@{/chatroom.css}" />
    <script type="importmap">
        {
          "imports": {
            "@stomp/stompjs": "https://ga.jspm.io/npm:@stomp/stompjs@7.0.0/esm6/index.js"
          }
        }
    </script>
    <script type="module">

        import * as StompJs from '@stomp/stompjs';

        document.addEventListener("DOMContentLoaded",connect);

        const stompClient = new StompJs.Client({
            brokerURL: 'ws://localhost:8080/chat'
        });

        stompClient.onConnect = (frame) => {
            //setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/messages', (greeting) => {
                showMessageOutput(JSON.parse(greeting.body));
            });
        };

        stompClient.onWebSocketError = (error) => {
            console.error('Error with websocket', error);
        };

        stompClient.onStompError = (frame) => {
            console.error('Broker reported error: ' + frame.headers['message']);
            console.error('Additional details: ' + frame.body);
        };

   /*     function setConnected(connected) {
            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;
            document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
            document.getElementById('response').innerHTML = '';
        }*/

        function connect() {
            stompClient.activate();
            console.log('Connected');
        }

        function disconnect() {
            stompClient.deactivate();
            //setConnected(false);
            console.log('Disconnected');
        }

        async function sendMessage() {
            const from = document.getElementById('username').value.trim();
            const msgInput = document.getElementById('text');
            stompClient.publish({destination: '/app/chat', body: JSON.stringify(
                {'from': from, 'text': msgInput.value.trim()})}
            );
            msgInput.value = '';

/*            const data = await fetch("/api/Messages/Home");
            console.log(JSON.parse(JSON.parse(data)));*/
        }


        function showMessageOutput(messageOutput) {
            let response = document.getElementById('responseBody');
            response.innerHTML +=
                `<div class="chat-message">
                       <strong>${messageOutput.from}:</strong> ${messageOutput.text}
                 </div>`;
        }

        window.connect = connect;
        window.disconnect = disconnect;
        window.sendMessage = sendMessage;

    </script>
</head>
<body>
<div class="container chat-container">

    <h1 class="text-center">Welcome to the Chat Room</h1>
    <div sec:authorize="isAuthenticated()" class="mb-3 text-center">
        Logged user: <span sec:authentication="name">?</span> |
        Roles: <span sec:authentication="principal.authorities">[ROLE_USER, ROLE_ADMIN]</span> |
        <form th:action="@{/logout}" method="post" style="display:inline">
            <input type="submit" value="Logout" class="btn btn-danger"/>
        </form>
    </div>
    <div class="chat-box">
        <div th:each = "message : ${messages}">
            <div class="chat-message">
                <strong th:text="${message.user.username}">User</strong>: <span th:text="${message.message}"></span>
            </div>
        </div>
        <div id = "responseBody"></div><!-- Additional messages will go here -->
    </div>
    <div class="message-input">
        <input type="text" id="text" class="form-control" placeholder="Type your message...">
        <button class="btn btn-primary" onclick="sendMessage();">Send</button>
    </div>
    <div class="text-center mt-3">
        <a href="/" class="btn btn-secondary">Back to Home Page</a>
    </div>
    <input id="username" th:value="*{username}"  hidden>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</body>
</html>
