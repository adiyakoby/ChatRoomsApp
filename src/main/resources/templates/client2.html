<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat WebSocket</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>-->
    <script type="importmap">
        {
          "imports": {
            "@stomp/stompjs": "https://ga.jspm.io/npm:@stomp/stompjs@7.0.0/esm6/index.js"
          }
        }
    </script>
    <script type="module">

        import * as StompJs from '@stomp/stompjs';

        const stompClient = new StompJs.Client({
            brokerURL: 'ws://localhost:8080/chat'
        });

        stompClient.onConnect = (frame) => {
            setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/messages', (greeting) => {
                console.log(greeting);
                showMessageOutput(JSON.parse(greeting.body));
            });
        };

        stompClient.onWebSocketError = (error) => {
            console.error('Error with websocket', error);
        };

        stompClient.onStompError = (frame) => {
            console.error('Broker reported error: ' + frame.headers['message']);
            console.error('Additional details: ' + frame.body);
        };

        function setConnected(connected) {
            document.getElementById('connect').disabled = connected;
            document.getElementById('disconnect').disabled = !connected;
            document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
            document.getElementById('response').innerHTML = '';
        }

        function connect() {
            stompClient.activate();
            console.log('Connected');
        }

        function disconnect() {
            stompClient.deactivate();
            setConnected(false);
            console.log('Disconnected');
        }

        function sendMessage() {
            const from = document.getElementById('from').value;
            console.log(from);
            const text = document.getElementById('text').value;
            stompClient.publish({destination: '/app/chat', body: JSON.stringify({'from': from, 'text': text})});
        }


        function showMessageOutput(messageOutput) {
            console.log(messageOutput);
            var response = document.getElementById('response');
            var p = document.createElement('p');
            p.style.wordWrap = 'break-word';
            p.appendChild(document.createTextNode(messageOutput.user.username + ": " + messageOutput.message + " (" + messageOutput.createdAt + ")"));
            response.appendChild(p);
        }

        window.connect = connect;
        window.disconnect = disconnect;
        window.sendMessage = sendMessage;

    </script>
</head>
<body> <!--onload="disconnect()"-->
<div>
    <div>
        <input type="text" id="from" placeholder="Choose a nickname"/>
    </div>
    <br />
    <div>
        <button id="connect" onclick="connect();">Connect</button>
        <button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
    </div>
    <br />
    <div id="conversationDiv" style="visibility: hidden;">
        <input type="text" id="text" placeholder="Write a message..."/>
        <button id="sendMessage" onclick="sendMessage();">Send</button>
        <p id="response"></p>
    </div>
</div>
</body>
</html>
